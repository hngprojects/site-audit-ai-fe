name: CI Pipeline

on:
  push:
    branches: [dev]

  pull_request:
    branches:
      - main
      - dev
      - staging

concurrency:
  group: cd-staging-frontend
  cancel-in-progress: true


jobs:
  staging-deployment:
    runs-on: hng-13-runner
    
    steps:
      # Stage 1.1: Setup and Cache Restoration
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Restore PNPM Store Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            node_modules/.pnpm
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: |
                if [ -f pnpm-lock.yaml ]; then
                pnpm install --no-frozen-lockfile
                else
                pnpm install
                fi

      - name: Restore Next.js Cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/package.json', '**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-

      # Stage 1.2: Code Quality and Testing
      - name: Run ESLint
        run: pnpm run lint
        continue-on-error: false

      - name: Type Checking
        run: pnpm run typecheck || echo "Type checking not configured, skipping"


      # Stage 1.3: Build Artifact Creation
      - name: Create Environment File
        run: |
          cat << EOF > .env
          NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_WAITLIST_API_URL=${{ secrets.NEXT_PUBLIC_WAITLIST_API_URL }}
          # Add other required environment variables
          EOF

      - name: Build Next.js Application
        run: pnpm run build
        env:
          # Include all required build-time environment variables
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXT_PUBLIC_API_URL }}
          NEXT_PUBLIC_WAITLIST_API_URL: ${{ secrets.NEXT_PUBLIC_WAITLIST_API_URL }}

      - name: Save Next.js Cache
        uses: actions/cache@v4
        with:
          path: |
            .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx', '**/package.json', '**/pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-nextjs-


      - name: Build Success Notification
        run: echo "âœ… CI Pipeline completed successfully - Application is ready for deployment"

 