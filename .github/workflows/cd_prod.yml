name: CD Production Frontend

on:
  push:
     branches:
        - main
  workflow_dispatch:

concurrency:
  group: cd-prod-frontend
  cancel-in-progress: true

jobs:
  prod-deployment:
    runs-on: hng-13-runner

    env:
        DEPLOY_ENV: staging
        DEPLOY_HOST: ${{ secrets.PROD_HOST }}
        DEPLOY_USER: ${{ secrets.PROD_SSH_USER }}
        DEPLOY_PATH: ${{ secrets.PROD_APP_DIR }}
        SERVICE_NAME: ${{ secrets.PROD_SERVICE_NAME }}
        SERVER_NAME: ${{ secrets.PROD_DOMAIN }}
        APP_PORT: ${{ secrets.PROD_APP_PORT }}
        APP_URL: ${{ secrets.PROD_APP_URL }}
        ENV_FILE: ${{ secrets.PROD_ENV_FILE }}
        SSH_PORT: ${{ secrets.PROD_SSH_PORT }}
        NGINX_LOG_PREFIX: sitemate-staging-fe
        NODE_VERSION: '20'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: ./build/
      
      - name: Configure SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
            ssh-private-key: ${{ secrets.PROD_SSH_KEY }}
              
      - name: Add remote host to known hosts
        run: |
          ssh-keyscan -p "${SSH_PORT:-22}" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
      - name: Ensure remote directory exists
        run: |
          ssh -p "${SSH_PORT:-22}" ${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_HOST }} "mkdir -p" ${{ secrets.PROD_APP_DIR }}

      - name: Deploy
        run: |
         scp -r ./build/* ${{ secrets.PROD_SSH_USER }}@${{ secrets.PROD_HOST }}:${{ secrets.PROD_APP_DIR }}
        

      - name: Install envsubst
        run: |
          sudo apt-get update
          sudo apt-get install -y gettext-base
        
      - name: Prepare config templates
        env:
          APP_ROOT: ${{ env.DEPLOY_PATH }}
        run: |
          if [ -z "$SERVER_NAME" ] || [ -z "$APP_PORT" ]; then
            echo "::error::SERVER_NAME or APP_PORT secrets missing for $DEPLOY_ENV"
            exit 1
          fi
          SERVICE_USER_VALUE="${SERVICE_USER:-$DEPLOY_USER}"
          SERVICE_GROUP_VALUE="${SERVICE_GROUP:-$SERVICE_USER_VALUE}"
          export SERVER_NAME APP_PORT APP_ROOT NGINX_LOG_PREFIX DEPLOY_ENV
          export SERVICE_USER="$SERVICE_USER_VALUE"
          export SERVICE_GROUP="$SERVICE_GROUP_VALUE"
          export NODE_BIN="${APP_ROOT}/node_modules/.bin"
          export NPM_START="${APP_ROOT}/node_modules/.bin/next start"
          envsubst '$SERVER_NAME $APP_PORT $APP_ROOT $NGINX_LOG_PREFIX' < deploy/nginx/site-audit-ai-fe.conf.tpl > deploy/nginx/site-audit-ai-fe.conf
          envsubst '$SERVICE_USER $SERVICE_GROUP $APP_PORT $APP_ROOT $DEPLOY_ENV $SERVICE_NAME $NPM_START' < deploy/systemd/site-audit-ai-fe.service.tpl > deploy/systemd/site-audit-ai-fe.service
        
      - name: Copy nginx config
        run: |
          scp -P "${SSH_PORT:-22}" deploy/nginx/site-audit-ai-fe.conf "$DEPLOY_USER@$DEPLOY_HOST:/tmp/site-audit-ai-fe.conf"

      - name: Copy systemd service
        run: |
          scp -P "${SSH_PORT:-22}" deploy/systemd/site-audit-ai-fe.service "$DEPLOY_USER@$DEPLOY_HOST:/tmp/site-audit-ai-fe.service"

      - name: Install dependencies, build, and restart services
        run: |
          ssh -p "${SSH_PORT:-22}" "$DEPLOY_USER@$DEPLOY_HOST" \
            "DEPLOY_PATH='$DEPLOY_PATH' SERVICE_NAME='$SERVICE_NAME' DEPLOY_ENV='$DEPLOY_ENV' APP_PORT='$APP_PORT' NODE_VERSION='$NODE_VERSION' bash -s" <<'EOF'
              set -euo pipefail
              export PATH="$HOME/.local/bin:$HOME/.nvm/versions/node/v${NODE_VERSION}/bin:$PATH"
              APP_DIR="${DEPLOY_PATH}"
              SERVICE="${SERVICE_NAME}"
              
              if [ ! -d "$APP_DIR" ]; then
                mkdir -p "$APP_DIR"
              fi
              cd "$APP_DIR"
              
              # Install system dependencies
              sudo apt-get update -y
              sudo apt-get install -y nginx certbot python3-certbot-nginx curl
              
              # Install Node.js via nvm if not present
              if ! command -v node >/dev/null 2>&1; then
                curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
                export NVM_DIR="$HOME/.nvm"
                [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                nvm install ${NODE_VERSION}
                nvm use ${NODE_VERSION}
              fi
              

              
              # Configure Nginx
              NGINX_SITE="/etc/nginx/sites-available/${SERVICE}.conf"
              sudo mv /tmp/site-audit-ai-fe.conf "$NGINX_SITE"
              sudo ln -sf "$NGINX_SITE" "/etc/nginx/sites-enabled/${SERVICE}.conf"
              sudo nginx -t
              sudo systemctl reload nginx
              
              # Configure and restart systemd service
              sudo mv /tmp/site-audit-ai-fe.service "/etc/systemd/system/${SERVICE}.service"
              sudo chown root:root "/etc/systemd/system/${SERVICE}.service"
              sudo systemctl daemon-reload
              sudo systemctl enable "${SERVICE}"
              sudo systemctl restart "$SERVICE"
              
              # Wait for service to start
              sleep 5
              
              # Local health check
              LOCAL_HEALTH_URL="http://127.0.0.1:${APP_PORT}"
              echo "Checking local health endpoint at $LOCAL_HEALTH_URL"
              for attempt in $(seq 1 5); do
                STATUS_CODE=$(curl -sk -o /tmp/local_health_response -w "%{http_code}" "$LOCAL_HEALTH_URL" || echo "000")
                if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "304" ]; then
                  echo "Local health check succeeded (status $STATUS_CODE):"
                  cat /tmp/local_health_response 2>/dev/null || true
                  rm -f /tmp/local_health_response
                  break
                fi
                echo "Local attempt $attempt failed (status $STATUS_CODE). Retrying..."
                sleep 3
              done
          EOF

      - name: Verify health endpoint
        run: |
          if [ -z "$APP_URL" ]; then
            echo "::error::APP_URL secret missing for $DEPLOY_ENV"
            exit 1
          fi
          HEALTH_URL="${APP_URL%/}"
          echo "Checking $HEALTH_URL"
          for attempt in $(seq 1 5); do
            STATUS_CODE=$(curl -sk -o /tmp/health_response -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$STATUS_CODE" = "200" ] || [ "$STATUS_CODE" = "304" ]; then
              echo "Health check succeeded (status $STATUS_CODE):"
              cat /tmp/health_response 2>/dev/null || true
              rm -f /tmp/health_response
              exit 0
            fi
            echo "Attempt $attempt failed (status $STATUS_CODE). Retrying..."
            sleep 5
          done
          echo "::error::Service did not pass health check"
          cat /tmp/health_response 2>/dev/null || true
          exit 1

      - name: Notify deployment
        if: always()
        run: |
          echo "Deployed $GITHUB_SHA to $DEPLOY_ENV (${APP_URL})"


    
   